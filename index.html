<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light Waves Reveals</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            min-height: 100vh;
            line-height: 1.6;
        }
        
        #mainContainer {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Title Section - No background box */
        .title-section {
            text-align: center;
            padding: 60px 20px 40px;
        }
        
        .main-title {
            font-size: 64px;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }
        
        /* Wallet Connection Section */
        .wallet-section {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #2a2a2a;
            text-align: center;
        }
        
        .wallet-section h2 {
            margin-bottom: 20px;
            color: white;
            font-size: 24px;
        }
        
        .wallet-section p {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        #connectWalletBtn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        #connectWalletBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.4);
        }
        
        #walletAddress {
            color: #3b82f6;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            margin-top: 20px;
            padding: 12px 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            display: inline-block;
        }
        
        /* Wallet Selection Modal */
        #walletOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 999;
            backdrop-filter: blur(10px);
        }
        
        #walletSelectionBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1a1a;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            z-index: 1000;
            border: 1px solid #2a2a2a;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .modal-header h3 {
            color: #ffffff;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .modal-header p {
            color: #666;
            font-size: 14px;
        }
        
        .wallet-option {
            background: #252525;
            border: 2px solid transparent;
            padding: 20px;
            margin: 12px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
        }
        
        .wallet-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .wallet-option:not(.disabled):hover {
            border-color: #3b82f6;
            background: #2a2a2a;
            transform: translateX(5px);
        }
        
        .wallet-icon {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .wallet-name {
            flex: 1;
            font-weight: 500;
            color: #e0e0e0;
        }
        
        .wallet-status {
            font-size: 12px;
            color: #666;
        }
        
        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #666;
            font-size: 28px;
            cursor: pointer;
            transition: color 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Light Waves Section */
        #lightwavesSection {
            margin-top: 40px;
        }
        
        .section-header {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            border: 1px solid #2a2a2a;
            border-bottom: none;
        }
        
        .section-header h2 {
            color: white;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .section-header p {
            color: #666;
            font-size: 14px;
        }
        
        .lightwave-list {
            background: #141414;
            border: 1px solid #2a2a2a;
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 20px;
        }
        
        .lightwave-item {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 20px;
            margin: 12px 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
        }
        
        .lightwave-item:hover {
            border-color: #3b82f6;
            background: #1e1e1e;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        .lightwave-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            accent-color: #3b82f6;
            cursor: pointer;
        }
        
        .lw-number {
            color: white;
            font-weight: 700;
            font-size: 18px;
        }
        
        .lw-status {
            color: #666;
            font-size: 14px;
            margin-left: auto;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }
        
        /* Reveal Section */
        #revealSection {
            background: linear-gradient(135deg, #1a1a1a 0%, #1e1e1e 100%);
            padding: 40px;
            border-radius: 16px;
            margin-top: 30px;
            border: 1px solid #2a2a2a;
            text-align: center;
        }
        
        #selectedCount {
            font-size: 24px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        #totalCost {
            color: #3b82f6;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 30px;
        }
        
        #revealBtn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 16px 48px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        
        #revealBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.4);
        }
        
        .message-box {
            padding: 20px;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        #noWalletsMsg, #errorBox {
            background: #7f1d1d;
            border: 1px solid #dc2626;
            color: #fecaca;
        }
        
        #loadingBox {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #999;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #333;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #emptyMessage {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 60px 40px;
            text-align: center;
            color: #666;
            border-radius: 12px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="mainContainer">
        <div class="title-section">
            <h1 class="main-title">Light Waves Reveals</h1>
        </div>

        <div class="wallet-section">
            <h2>Step 1: Connect Your Wallet</h2>
            <p>Select your Bitcoin wallet to view unrevealed Light Waves</p>
            <button id="connectWalletBtn">Connect Wallet</button>
            <div id="walletAddress" class="hidden"></div>
        </div>

        <div id="walletOverlay">
            <div id="walletSelectionBox">
                <button class="close-btn" onclick="closeWalletSelection()">Ã—</button>
                <div class="modal-header">
                    <h3>Select Your Wallet</h3>
                    <p>Choose a wallet to connect</p>
                </div>
                
                <div id="xverseOption" class="wallet-option">
                    <div class="wallet-icon">X</div>
                    <div>
                        <div class="wallet-name">Xverse</div>
                        <div class="wallet-status" id="xverseStatus">Checking...</div>
                    </div>
                </div>
                
                <div id="unisatOption" class="wallet-option">
                    <div class="wallet-icon">U</div>
                    <div>
                        <div class="wallet-name">Unisat</div>
                        <div class="wallet-status" id="unisatStatus">Checking...</div>
                    </div>
                </div>
                
                <div id="leatherOption" class="wallet-option">
                    <div class="wallet-icon">L</div>
                    <div>
                        <div class="wallet-name">Leather (Hiro)</div>
                        <div class="wallet-status" id="leatherStatus">Checking...</div>
                    </div>
                </div>
                
                <div id="magicedenOption" class="wallet-option">
                    <div class="wallet-icon">M</div>
                    <div>
                        <div class="wallet-name">Magic Eden</div>
                        <div class="wallet-status" id="magicedenStatus">Checking...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="noWalletsMsg" class="message-box hidden">
            <strong>No Bitcoin wallets detected</strong><br>
            Please install Xverse, Unisat, Leather, or Magic Eden browser extension
        </div>
        
        <div id="loadingBox" class="message-box hidden">
            Loading your Light Waves
            <span class="loading-spinner"></span>
        </div>

        <div id="lightwavesSection" class="hidden">
            <div class="section-header">
                <h2>Step 2: Select Light Waves to Reveal</h2>
                <p>Choose which Light Waves you want to reveal. Each selection will show the estimated cost.</p>
            </div>
            <div class="lightwave-list">
                <div id="lightwavesRepeater">
                </div>
                <div id="emptyMessage" class="hidden">
                    <h3 style="color: white; margin-bottom: 10px;">No Unrevealed Light Waves Found</h3>
                    <p>This wallet doesn't contain any unrevealed Light Waves.</p>
                </div>
            </div>
        </div>

        <div id="revealSection" class="hidden">
            <h2 style="color: white; margin-bottom: 30px;">Step 3: Confirm and Reveal</h2>
            <div id="selectedCount"></div>
            <div id="totalCost"></div>
            <button id="revealBtn">Reveal Selected Light Waves</button>
        </div>

        <div id="errorBox" class="message-box hidden">
            <span id="errorMessage"></span>
        </div>
    </div>

    <script>
        // FIX 1: Correct iframe detection
        (function () {
            const isEmbedded = window.top !== window.self;
            const ref = document.referrer || '';
            // FIXED: Use your actual domain here
            const allowHosts = [
                'kanetix.io',
                'localhost'  // For testing
            ];
            const allowed = allowHosts.some(h => ref.includes(h));
            
            // Allow embedding from specified hosts
            if (isEmbedded && !allowed) {
                console.log('Page embedded from non-allowed host:', ref);
                // Optionally redirect or show warning
                // window.top.location = window.location;
            }
        })();

        // Simple JWT-like token creator (simplified version of jsontokens)
        // This may be needed for other MagicEden operations like signing
        function createUnsecuredToken(payload) {
            const header = { typ: 'JWT', alg: 'none' };
            const encodedHeader = btoa(JSON.stringify(header)).replace(/=/g, '');
            const encodedPayload = btoa(JSON.stringify(payload)).replace(/=/g, '');
            return `${encodedHeader}.${encodedPayload}.`;
        }

        const BLOCKSTREAM_API = 'https://blockstream.info/api';
        const PARENT_ID = '7089979d8b72cff7953aa29f210b11dce22d950ff6961d4319e28d45331856dci0';
        const MIN_PADDING_SATS = 330;

        var connectedWallet = null;
        let selectedLightWaves = new Set();
        let unrevealedLightWaves = [];
        let walletCheckInterval = null;

        document.addEventListener('DOMContentLoaded', function() {
            setupEventHandlers();
            // Start checking for wallets after a short delay
            setTimeout(() => {
                checkWalletsRepeatedly();
            }, 500);
        });

        function checkWalletsRepeatedly() {
            detectWallets();
            
            walletCheckInterval = setInterval(() => {
                detectWallets();
            }, 2000);
        }

        function setupEventHandlers() {
            document.getElementById('connectWalletBtn').addEventListener('click', showWalletSelection);
            
            document.getElementById('walletOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeWalletSelection();
                }
            });
            
            document.getElementById('revealBtn').addEventListener('click', revealSelected);
        }

        function detectWallets() {
            const wallets = {
                xverse: !!(window.XverseProviders?.BitcoinProvider || window.xverse || window.BitcoinProvider),
                unisat: !!window.unisat,
                leather: !!window.LeatherProvider,
                magiceden: !!(window.magicEden?.bitcoin && window.magicEden.bitcoin.isMagicEden)
            };
            
            updateWalletStatus('xverse', wallets.xverse);
            updateWalletStatus('unisat', wallets.unisat);
            updateWalletStatus('leather', wallets.leather);
            updateWalletStatus('magiceden', wallets.magiceden);
            
            console.log('Detected wallets:', wallets);
            
            return wallets;
        }

        function updateWalletStatus(walletName, isDetected) {
            const statusEl = document.getElementById(walletName + 'Status');
            const optionEl = document.getElementById(walletName + 'Option');
            
            if (statusEl && optionEl) {
                // Check if status actually changed
                const currentStatus = statusEl.textContent;
                const newStatus = isDetected ? 'Ready' : 'Not installed';
                
                // Only update if status changed
                if (currentStatus !== newStatus) {
                    if (isDetected) {
                        statusEl.textContent = 'Ready';
                        statusEl.style.color = '#10b981';
                        optionEl.classList.remove('disabled');
                        
                        // Only re-attach listeners if wallet just became available
                        if (currentStatus !== 'Ready') {
                            // Remove old listeners by cloning
                            optionEl.replaceWith(optionEl.cloneNode(true));
                            const newOptionEl = document.getElementById(walletName + 'Option');
                            
                            // Add new listeners
                            switch(walletName) {
                                case 'xverse':
                                    newOptionEl.addEventListener('click', () => connectXverse());
                                    break;
                                case 'unisat':
                                    newOptionEl.addEventListener('click', () => connectUnisat());
                                    break;
                                case 'leather':
                                    newOptionEl.addEventListener('click', () => connectLeather());
                                    break;
                                case 'magiceden':
                                    newOptionEl.addEventListener('click', () => connectMagicEden());
                                    break;
                            }
                        }
                    } else {
                        statusEl.textContent = 'Not installed';
                        statusEl.style.color = '#666';
                        optionEl.classList.add('disabled');
                    }
                }
            }
        }

        function showWalletSelection() {
            const wallets = detectWallets();
            
            const hasAnyWallet = Object.values(wallets).some(v => v);
            
            if (!hasAnyWallet) {
                document.getElementById('noWalletsMsg').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('noWalletsMsg').classList.add('hidden');
                }, 5000);
                return;
            }
            
            document.getElementById('walletOverlay').style.display = 'block';
        }

        function closeWalletSelection() {
            document.getElementById('walletOverlay').style.display = 'none';
        }

        async function connectXverse() {
            const provider = 
                (window.XverseProviders && window.XverseProviders.BitcoinProvider) ||
                window.xverse ||
                window.BitcoinProvider;

            if (!provider) return showError('Xverse wallet not detected');

            try {
                const resp = await provider.request('wallet_connect', {
                    addresses: ['ordinals', 'payment'],
                    network: 'Mainnet',
                    message: 'Light Waves: connect for reveal'
                });

                if (resp?.result?.addresses?.length) {
                    const addrs = resp.result.addresses;
                    const ord = addrs.find(a => a.purpose === 'ordinals');
                    const pay = addrs.find(a => a.purpose === 'payment') || ord;

                    connectedWallet = {
                        type: 'xverse',
                        ordinalsAddress: ord.address,
                        paymentAddress: pay.address,
                        ordPub: ord.publicKey || '',
                        payPub: pay.publicKey || ord.publicKey || '',
                        provider
                    };
                    onWalletConnected();
                } else {
                    showError('Xverse did not return addresses');
                }
            } catch (err) {
                console.error('Xverse error:', err);
                showError('Failed to connect Xverse');
            }
        }

        async function connectUnisat() {
            if (!window.unisat) {
                showError('Unisat wallet not detected');
                return;
            }
            
            try {
                const accounts = await window.unisat.requestAccounts();
                const publicKey = await window.unisat.getPublicKey();
                
                connectedWallet = {
                    type: 'unisat',
                    ordinalsAddress: accounts[0],
                    paymentAddress: accounts[0],
                    ordPub: publicKey,
                    payPub: publicKey,
                    provider: window.unisat
                };
                
                onWalletConnected();
            } catch (error) {
                if (error.message && error.message.includes('User rejected')) {
                    showError('Connection cancelled');
                } else {
                    showError('Connection failed');
                }
            }
        }

        async function connectLeather() {
            if (!window.LeatherProvider) {
                showError('Leather wallet not detected');
                return;
            }
            
            try {
                const response = await window.LeatherProvider.request('getAddresses');
                
                if (response.status === 'success') {
                    const addresses = response.result.addresses;
                    const taproot = addresses.find(a => a.type === 'p2tr');
                    const payment = addresses.find(a => a.type === 'p2wpkh') || taproot;
                    
                    if (!taproot) {
                        showError('Enable Taproot addresses in Leather wallet');
                        return;
                    }
                    
                    connectedWallet = {
                        type: 'leather',
                        ordinalsAddress: taproot.address,
                        paymentAddress: payment.address,
                        ordPub: taproot.publicKey,
                        payPub: payment.publicKey,
                        provider: window.LeatherProvider
                    };
                    
                    onWalletConnected();
                }
            } catch (error) {
                if (error.message && error.message.includes('User rejected')) {
                    showError('Connection cancelled');
                } else {
                    showError('Connection failed');
                }
            }
        }

        // FIX 2: Direct MagicEden connection using createUnsecuredToken
        async function connectMagicEden() {
            try {
                const provider = window.magicEden?.bitcoin;
                if (!provider || !provider.isMagicEden) {
                    showError('Magic Eden wallet not detected. Please install the Magic Eden browser extension.');
                    return;
                }

                console.log('Connecting to MagicEden...');

                // Create the payload for connection
                const payload = {
                    purposes: ['payment', 'ordinals'],
                    message: 'Light Waves: connect for reveal'
                };
                
                // Create unsigned token as per MagicEden docs
                const request = createUnsecuredToken(payload);
                
                console.log('Sending connect request to MagicEden provider...');
                
                try {
                    // This triggers the popup, but might handle response differently
                    const response = await provider.connect(request);
                    
                    console.log('MagicEden response:', response);
                    
                    // MagicEden might return addresses in different formats
                    if (response) {
                        if (response.addresses) {
                            handleMagicEdenResponse(response.addresses);
                        } else if (Array.isArray(response)) {
                            handleMagicEdenResponse(response);
                        } else if (response.address) {
                            // Single address response
                            handleMagicEdenResponse([response]);
                        } else {
                            // Try to get addresses another way after successful connect
                            console.log('Connected but no addresses in response, trying to get accounts...');
                            // MagicEden might expose addresses differently after connection
                            if (provider.accounts || provider.selectedAddress) {
                                const addresses = [{
                                    address: provider.selectedAddress || provider.accounts[0],
                                    purpose: 'ordinals'
                                }];
                                handleMagicEdenResponse(addresses);
                            } else {
                                console.error('Unexpected response format:', response);
                                showError('Connected but could not retrieve addresses');
                            }
                        }
                    }
                } catch (error) {
                    // Check if it's a user rejection
                    if (error.message && error.message.includes('rejected')) {
                        showError('Connection cancelled by user');
                    } else {
                        // Log the error but don't assume failure - check if we're actually connected
                        console.log('Connection method threw error but checking connection status:', error);
                        
                        // Sometimes providers throw errors but still connect
                        // Check if we can access addresses despite the error
                        if (provider.accounts && provider.accounts.length > 0) {
                            console.log('Despite error, found accounts:', provider.accounts);
                            const addresses = provider.accounts.map(acc => ({
                                address: typeof acc === 'string' ? acc : acc.address,
                                purpose: 'ordinals'
                            }));
                            handleMagicEdenResponse(addresses);
                        } else if (provider.selectedAddress) {
                            console.log('Despite error, found selectedAddress:', provider.selectedAddress);
                            handleMagicEdenResponse([{
                                address: provider.selectedAddress,
                                purpose: 'ordinals'
                            }]);
                        } else {
                            console.error('MagicEden connection error:', error);
                            showError('Failed to connect Magic Eden wallet');
                        }
                    }
                }
                
            } catch (err) {
                console.error('MagicEden error:', err);
                showError('Failed to connect Magic Eden: ' + err.message);
            }
        }

        function handleMagicEdenResponse(addresses) {
            console.log('MagicEden addresses received:', addresses);
            
            const ord = addresses.find(a => 
                a.purpose === 'ordinals' || 
                a.type === 'p2tr' || 
                (a.address && a.address.startsWith('bc1p'))
            ) || addresses[0];
            
            const pay = addresses.find(a => 
                a.purpose === 'payment' || 
                a.type === 'p2wpkh' || 
                (a.address && a.address.startsWith('bc1q'))
            ) || ord;

            connectedWallet = {
                type: 'magiceden',
                ordinalsAddress: ord.address,
                paymentAddress: pay.address,
                ordPub: ord.publicKey || '',
                payPub: pay.publicKey || ord.publicKey || '',
                provider: window.magicEden.bitcoin
            };
            
            onWalletConnected();
        }

        function onWalletConnected() {
            if (walletCheckInterval) {
                clearInterval(walletCheckInterval);
            }
            
            closeWalletSelection();
            
            document.getElementById('connectWalletBtn').style.display = 'none';
            document.getElementById('walletAddress').textContent = 
                `Connected: ${connectedWallet.ordinalsAddress.slice(0, 6)}...${connectedWallet.ordinalsAddress.slice(-4)}`;
            document.getElementById('walletAddress').classList.remove('hidden');
            
            loadUnrevealedLightWaves();
        }

        async function loadUnrevealedLightWaves() {
            document.getElementById('loadingBox').classList.remove('hidden');
            document.getElementById('lightwavesSection').classList.add('hidden');
            
            try {
                const response = await fetch(`${BLOCKSTREAM_API}/address/${connectedWallet.ordinalsAddress}/utxo`);
                const utxos = await response.json();
                
                // For demo purposes, show mock data
                // In production, you'd check each UTXO for Light Wave inscriptions
                unrevealedLightWaves = [
                    { id: '1', number: '#1234', status: 'UNREVEALED' },
                    { id: '2', number: '#5678', status: 'UNREVEALED' },
                    { id: '3', number: '#9012', status: 'UNREVEALED' }
                ];
                
                document.getElementById('loadingBox').classList.add('hidden');
                
                if (unrevealedLightWaves.length === 0) {
                    document.getElementById('emptyMessage').classList.remove('hidden');
                    document.getElementById('lightwavesSection').classList.remove('hidden');
                } else {
                    displayLightWaves(unrevealedLightWaves);
                    document.getElementById('lightwavesSection').classList.remove('hidden');
                }
                
            } catch (error) {
                document.getElementById('loadingBox').classList.add('hidden');
                showError('Failed to load Light Waves');
            }
        }

        function displayLightWaves(lightWaves) {
            const repeater = document.getElementById('lightwavesRepeater');
            repeater.innerHTML = '';
            
            lightWaves.forEach((lw, index) => {
                const item = document.createElement('div');
                item.className = 'lightwave-item';
                item.innerHTML = `
                    <input type="checkbox" id="lw-check-${index}" data-id="${lw.id}">
                    <span class="lw-number">${lw.number}</span>
                    <span class="lw-status">${lw.status}</span>
                `;
                
                const checkbox = item.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedLightWaves.add(lw.id);
                    } else {
                        selectedLightWaves.delete(lw.id);
                    }
                    updateRevealUI();
                });
                
                repeater.appendChild(item);
            });
        }

        function updateRevealUI() {
            const count = selectedLightWaves.size;
            if (count > 0) {
                document.getElementById('revealSection').classList.remove('hidden');
                document.getElementById('selectedCount').textContent = `${count} Light Wave${count > 1 ? 's' : ''} selected`;
                updateFeeEstimate();
            } else {
                document.getElementById('revealSection').classList.add('hidden');
            }
        }

        function updateFeeEstimate() {
            const count = selectedLightWaves.size;
            const baseCost = count * MIN_PADDING_SATS;
            const networkFee = Math.ceil(count * 200 * 20);
            const totalCost = baseCost + networkFee;
            
            document.getElementById('totalCost').textContent = `Total Cost: ${totalCost.toLocaleString()} sats (~$${(totalCost * 0.0003).toFixed(2)} USD)`;
        }

        function revealSelected() {
            showError('Reveal functionality coming soon!');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorBox').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('errorBox').classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
